<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Cylinder | BREAKWAY GAS SUPPLY</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker.min.css">
  <link rel="stylesheet" href="style.css">
  <style>
    #map { height: 300px; width: 100%; border-radius: 8px; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="app-sidebar">
    <div class="sidebar-header">
      <h1>
        <span>BREAKWAY</span><br><span>GAS SUPPLY</span>
      </h1>
      <img src="gas.png" alt="Breakway Gas Supply Logo" class="sidebar-logo">
    </div>
  </div>
  <div class="page-content" style="position:relative;">
    <button type="button" id="backBtn" class="back-btn">← Back</button>
    <div class="card">
      <div class="card-header">
        <h1>Book Your Gas Cylinder</h1>
        <p>Confirm your details and place the order.</p>
      </div>

      <form id="bookingForm">
        <div class="form-group">
          <label for="cylinderType">Cylinder Type</label>
          <select id="cylinderType" required>
            <option value="" disabled selected>Select cylinder size</option>
            <option value="14.2kg">Domestic (14.2 kg)</option>
            <option value="5kg">Mini (5 kg)</option>
            <option value="19kg">Commercial (19 kg)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="quantity">Quantity (Max 2)</label>
          <input type="number" id="quantity" value="1" min="1" max="2" required />
        </div>
        <div class="form-group">
          <label for="address">Delivery Address</label>
          <div class="address-grid">
            <div class="form-group" style="grid-column: 1 / -1;">
              <input type="text" id="addressStreet" placeholder="Street Name / House No." required />
            </div>
            <div class="form-group">
              <input type="text" id="addressVillage" placeholder="Village / Town" required />
            </div>
            <div class="form-group">
              <input type="text" id="addressState" placeholder="State" required />
            </div>
            <div class="form-group">
              <input type="text" id="addressDistrict" placeholder="District" required />
            </div>
            <div class="form-group">
              <input type="text" id="addressPincode" placeholder="Pincode" required pattern="\d{6}" />
            </div>
          </div>
          <div id="mapContainer" style="display:none;"><!-- Map functionality can be re-enabled here if needed --></div>
        </div>
        <div class="form-group">
          <label>Payment Method</label>
          <div style="margin-top:8px;">
            <button type="button" id="choosePaymentBtn" class="btn" style="padding:8px 12px;">Choose Payment Method</button>
          </div>
          <div id="paymentOptions" style="display:none;margin-top:10px;">
            <input type="hidden" name="payment" id="paymentInput" value="cod">
            <div style="display:flex;gap:8px;">
              <button type="button" class="pay-btn" data-method="cod">Cash on Delivery</button>
              <button type="button" class="pay-btn" data-method="upi">UPI</button>
              <button type="button" class="pay-btn" data-method="card">Card</button>
            </div>
          </div>
        </div>
        <div id="cardDetails" style="display:none;">
          <div class="form-group">
            <label for="cardNumber">Card Number</label>
            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" pattern="\d{12,19}" />
          </div>
          <div class="form-group" style="display:flex;gap:8px;">
            <div style="flex:1;">
              <label for="expiry">Expiry</label>
              <input type="text" id="expiry" placeholder="MM/YY" />
            </div>
            <div style="width:120px;">
              <label for="cvv">CVV</label>
              <input type="password" id="cvv" placeholder="CVV" maxlength="4" />
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="deliveryDate">Preferred Delivery Date</label>
          <input type="text" id="deliveryDate" placeholder="Select a date" required readonly />
        </div>

        <div class="price-summary" style="margin-top: 20px; text-align: left; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;">
          <h3 style="margin-top: 0;">Price Details</h3>
          <p style="display:flex;justify-content:space-between;"><span>Cylinder Price:</span><strong id="priceCylinder">₹0</strong></p>
          <p style="display:flex;justify-content:space-between;"><span>Delivery Charge:</span><strong id="priceDelivery">₹0</strong></p>
          <p class="total" style="display:flex;justify-content:space-between;font-size: 18px; font-weight: bold; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;"><span>Total Amount:</span><strong id="priceTotal">₹0</strong></p>
        </div>

        <button type="submit" class="btn btn-submit" id="confirmOrderBtn">Confirm the Order</button>
      </form>
      <p class="back-link">
        <a href="dashboard.html">Back to Dashboard</a>
      </p>
    </div>
    <footer class="footer">
      <p>Admin: GORLA KIRAN(273). &copy; 2025 BREAKWAY GAS SUPPLY.</p>
      <div>
        <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a>
      </div>
    </footer>
  </div>
  <button id="themeToggleBtn" class="theme-toggle" aria-label="Toggle theme"></button>
  <script src="main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      // --- KYC Verification Check on Page Load ---
      const currentUserId = sessionStorage.getItem('currentUserId');
      if (currentUserId) {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const currentUser = users.find(u => u.id === currentUserId);
        if (!currentUser || currentUser.kycStatus !== 'verified') {
          showToast('Your account must be KYC verified to book a cylinder.', 'error');
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 2000);
          return; // Stop further execution
        }
      } else {
        // Not logged in, redirect
        window.location.href = 'login.html';
        return;
      }

      // --- Price Calculation Logic ---
      const cylinderTypeSelect = document.getElementById('cylinderType');
      const quantityInput = document.getElementById('quantity');
      const urlParams = new URLSearchParams(window.location.search);
      const stateSelect = document.getElementById('addressState');
      const districtSelect = document.getElementById('addressDistrict');

      var cardDetails = document.getElementById('cardDetails');
      var chooseBtn = document.getElementById('choosePaymentBtn');
      var paymentOptions = document.getElementById('paymentOptions');
      var paymentInput = document.getElementById('paymentInput');
      var payBtns = document.querySelectorAll('.pay-btn');

      // --- Date Picker ---
      const datepickerEl = document.getElementById('deliveryDate');
      if (datepickerEl) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        new Datepicker(datepickerEl, { 
          autohide: true, 
          format: 'yyyy-mm-dd', 
          startDate: tomorrow,
          container: '.page-content' // This is the definitive fix
        });
      }

      if (!cardDetails || !chooseBtn || !paymentOptions || !paymentInput) return;
      function setMethod(method) {
        paymentInput.value = method;
        payBtns.forEach(function (b) { b.classList.remove('selected'); });
        var active = paymentOptions.querySelector('[data-method="' + method + '"]');
        if (active) { active.classList.add('selected'); }
        if (method === 'card') cardDetails.style.display = 'block'; else cardDetails.style.display = 'none';
      }
      chooseBtn.addEventListener('click', function () {
        var isVisible = paymentOptions.style.display === 'block';
        paymentOptions.style.display = isVisible ? 'none' : 'block';
      });
      payBtns.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var method = btn.getAttribute('data-method');
          setMethod(method);
        });
      });
      setMethod(paymentInput.value || 'cod');

      // Fetch user data to pre-fill address
      async function loadUserData() {
        const currentUserId = sessionStorage.getItem('currentUserId');
        if (currentUserId) {
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          const currentUser = users.find(u => u.id === currentUserId);
          if (currentUser && typeof currentUser.address === 'object' && currentUser.address !== null) {
            document.getElementById('addressStreet').value = currentUser.address.street || '';
            document.getElementById('addressVillage').value = currentUser.address.village || '';
            document.getElementById('addressPincode').value = currentUser.address.pincode || '';
            // Pre-fill the new text inputs
            document.getElementById('addressState').value = currentUser.address.state || '';
            document.getElementById('addressDistrict').value = currentUser.address.district || '';
          }
        }
      }

      function updatePrice() {
        const cylinderType = cylinderTypeSelect.value;
        const quantity = parseInt(quantityInput.value, 10) || 0;
        const cylinderPriceEl = document.getElementById('priceCylinder');
        const deliveryChargeEl = document.getElementById('priceDelivery');
        const totalPriceEl = document.getElementById('priceTotal');

        if (cylinderType && quantity > 0 && GAS_PRICES[cylinderType]) {
          const cylinderPrice = GAS_PRICES[cylinderType].price * quantity;
          const totalAmount = cylinderPrice + DELIVERY_CHARGE;
          cylinderPriceEl.textContent = `₹${cylinderPrice}`;
          deliveryChargeEl.textContent = `₹${DELIVERY_CHARGE}`;
          totalPriceEl.textContent = `₹${totalAmount}`;
        } else {
          cylinderPriceEl.textContent = '₹0';
          deliveryChargeEl.textContent = '₹0';
          totalPriceEl.textContent = '₹0';
        }
      }

      // Pre-select cylinder from URL and update price
      const typeFromUrl = urlParams.get('type');
      if (typeFromUrl && cylinderTypeSelect.querySelector(`[value="${typeFromUrl}"]`)) {
        cylinderTypeSelect.value = typeFromUrl;
      }

      loadUserData(); // Load user data on page load
      updatePrice(); // Initial price calculation
      cylinderTypeSelect.addEventListener('change', updatePrice);
      quantityInput.addEventListener('input', updatePrice);
    });

    document.getElementById('backBtn').addEventListener('click', () => history.back());
  </script>
</body>
</html>